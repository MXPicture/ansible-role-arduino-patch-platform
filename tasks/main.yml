---

- name: Find all platform.txt files
  find:
    paths: "{{ arduino_platform_root }}"
    patterns: "platform.txt"
    recurse: true
  register: platform_txt_files

- name: Back up original platform.txt (if not already backed up)
  copy:
    src: "{{ item.path }}"
    dest: "{{ item.path }}.bak"
    remote_src: true
    force: false
  loop: "{{ platform_txt_files.files }}"
  when: arduino_patch_mode == 'patch'
  loop_control:
    label: "{{ item.path }}"

- name: Remove '-w' and inject warning flags
  replace:
    path: "{{ item.path }}"
    regexp: '^(compiler\.warning_flags=.*)(?:\s|^)-w(?:\s|$)'
    replace: '\1 -Wall -Wextra -Werror=return-type'
    backup: no
  loop: "{{ platform_txt_files.files }}"
  when: arduino_patch_mode == 'patch'
  loop_control:
    label: "{{ item.path }}"

- name: Restore platform.txt from backup
  copy:
    src: "{{ item.path }}.bak"
    dest: "{{ item.path }}"
    remote_src: true
    force: true
  loop: "{{ platform_txt_files.files }}"
  when:
    - arduino_patch_mode == 'restore'
    - lookup('file', item.path + '.bak', errors='ignore') is not none
  loop_control:
    label: "{{ item.path }}"
